apiVersion: v1
kind: ConfigMap
metadata:
  name: transcode-script
  namespace: media-transcode
data:
  transcode.sh: |
    #!/bin/sh
    
    INPUT_DIR="/media/source"
    OUTPUT_DIR="/media/destination"
    FAILED_DIR="/media/destination/_failed"
    POD_NAME="${HOSTNAME:-unknown}"
    
    echo "==================================="
    echo "Video Transcoding Job Started"
    echo "==================================="
    echo "Pod: $POD_NAME"
    echo "Input directory: $INPUT_DIR"
    echo "Output directory: $OUTPUT_DIR"
    echo "Failed directory: $FAILED_DIR"
    echo "Date: $(date)"
    echo ""
    
    # Create output directories if they don't exist
    mkdir -p "$OUTPUT_DIR"
    mkdir -p "$FAILED_DIR"
    
    # Clean up stale lock files from previous failed/restarted pods
    echo "üßπ Cleaning up stale lock files (older than 30 minutes)..."
    stale_locks=0
    find "$OUTPUT_DIR" -type d -name "*.lock" -mmin +30 2>/dev/null | while read -r stale_lock; do
      echo "   Removing stale lock: $(basename "$stale_lock")"
      rmdir "$stale_lock" 2>/dev/null || rm -rf "$stale_lock"
      stale_locks=$((stale_locks + 1))
    done
    if [ "$stale_locks" -eq 0 ]; then
      echo "   No stale locks found"
    else
      echo "   Cleaned $stale_locks stale locks"
    fi
    echo ""
    
    # Counter for processed files
    PROCESSED=0
    SKIPPED=0
    FAILED=0
    TOTAL=0
    
    # Count total files first
    echo "üìä Scanning for video files..."
    TOTAL=$(find "$INPUT_DIR" -type f \( \
      -iname "*.mkv" -o \
      -iname "*.avi" -o \
      -iname "*.mov" -o \
      -iname "*.wmv" -o \
      -iname "*.flv" -o \
      -iname "*.webm" -o \
      -iname "*.m4v" -o \
      -iname "*.mpg" -o \
      -iname "*.mpeg" -o \
      -iname "*.mp4" -o \
      -iname "*.ts" \
    \) | wc -l)
    
    echo "Found $TOTAL video files to process"
    echo ""
    
    CURRENT=0
    
    # Find all video files recursively in all subfolders (common formats)
    find "$INPUT_DIR" -type f \( \
      -iname "*.mkv" -o \
      -iname "*.avi" -o \
      -iname "*.mov" -o \
      -iname "*.wmv" -o \
      -iname "*.flv" -o \
      -iname "*.webm" -o \
      -iname "*.m4v" -o \
      -iname "*.mpg" -o \
      -iname "*.mpeg" -o \
      -iname "*.mp4" -o \
      -iname "*.ts" \
    \) | while read -r input_file; do
      
      CURRENT=$((CURRENT + 1))
      
      # Get relative path from input dir
      relative_path="${input_file#$INPUT_DIR/}"
      
      # Create output filename (preserve folder structure, change extension to .mp4)
      filename=$(basename "$input_file")
      dirname=$(dirname "$relative_path")
      base_name="${filename%.*}"
      output_file="$OUTPUT_DIR/$dirname/${base_name}.mp4"
      
      # Create output subdirectory (preserves folder structure)
      mkdir -p "$OUTPUT_DIR/$dirname"
      
      # Lock file to prevent concurrent processing by multiple pods
      lock_file="$output_file.lock"
      
      # Check if lock exists and is stale (older than 30 minutes = 1800 seconds)
      if [ -d "$lock_file" ]; then
        lock_age=$(($(date +%s) - $(stat -c %Y "$lock_file" 2>/dev/null || stat -f %m "$lock_file" 2>/dev/null || echo 0)))
        if [ "$lock_age" -gt 1800 ]; then
          echo "[$CURRENT/$TOTAL] üßπ Cleaning stale lock (${lock_age}s old): $relative_path"
          rmdir "$lock_file" 2>/dev/null || rm -rf "$lock_file"
        fi
      fi
      
      # Try to create lock file (atomic operation)
      if ! mkdir "$lock_file" 2>/dev/null; then
        echo "[$CURRENT/$TOTAL] üîí SKIP: $relative_path (being processed by another pod)"
        SKIPPED=$((SKIPPED + 1))
        continue
      fi
      
      # Skip if output already exists (delete source since output is complete)
      if [ -f "$output_file" ]; then
        echo "[$CURRENT/$TOTAL] ‚è≠Ô∏è  SKIP: $relative_path (output already exists)"
        echo "   üóëÔ∏è  Deleting source file (output complete)"
        rm "$input_file"
        rmdir "$lock_file"
        SKIPPED=$((SKIPPED + 1))
        continue
      fi
      
      echo ""
      echo "[$CURRENT/$TOTAL] üé¨ Processing: $relative_path (Pod: $POD_NAME)"
      echo "   Output: $output_file"
      echo "   Started: $(date '+%H:%M:%S')"
      
      # Check if input is already H.264/AAC MP4
      codec_info=$(ffprobe -v error -select_streams v:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 "$input_file" 2>/dev/null || echo "unknown")
      audio_codec=$(ffprobe -v error -select_streams a:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 "$input_file" 2>/dev/null || echo "unknown")
      
      if [ "$codec_info" = "h264" ] && [ "$audio_codec" = "aac" ] && [ "${filename##*.}" = "mp4" ]; then
        echo "   ‚ÑπÔ∏è  Already in correct format, moving to destination..."
        if mv "$input_file" "$output_file"; then
          echo "   ‚úÖ Moved successfully (source deleted)"
          rmdir "$lock_file"
          SKIPPED=$((SKIPPED + 1))
        else
          echo "   ‚ùå Move failed, keeping source"
          rmdir "$lock_file"
          FAILED=$((FAILED + 1))
        fi
        continue
      fi
      
      # Transcode with GPU acceleration if available
      if ffmpeg -hwaccels 2>/dev/null | grep -q cuda; then
        echo "   üöÄ Using NVIDIA GPU acceleration (decode + encode)"
        if ffmpeg -hide_banner -stats -nostdin \
          -hwaccel cuda -hwaccel_output_format cuda \
          -i "$input_file" \
          -c:v h264_nvenc \
          -preset p4 -tune hq -rc vbr -cq 23 -b:v 5M -maxrate 10M \
          -c:a aac -b:a 192k -ac 2 \
          -movflags +faststart \
          -f mp4 \
          "$output_file.tmp" </dev/null 2>&1; then
          
          mv "$output_file.tmp" "$output_file"
          echo "   ‚úÖ SUCCESS - Deleting source ($(date '+%H:%M:%S'))"
          rm "$input_file"
          rmdir "$lock_file"
          PROCESSED=$((PROCESSED + 1))
        else
          echo "   ‚ùå FAILED - Moving to failed directory ($(date '+%H:%M:%S'))"
          rm -f "$output_file.tmp"
          # Move failed file to failed directory to prevent infinite retries
          failed_dest="$FAILED_DIR/$dirname"
          mkdir -p "$failed_dest"
          if mv "$input_file" "$failed_dest/"; then
            echo "   üìÅ Moved to: $failed_dest/"
          else
            echo "   ‚ö†Ô∏è  Could not move to failed directory, file remains in source"
          fi
          rmdir "$lock_file"
          FAILED=$((FAILED + 1))
        fi
      else
        echo "   üíª Using CPU encoding (no GPU detected)"
        if ffmpeg -hide_banner -stats -nostdin \
          -i "$input_file" \
          -c:v libx264 -preset medium -crf 23 \
          -c:a aac -b:a 192k -ac 2 \
          -movflags +faststart \
          -f mp4 \
          "$output_file.tmp" </dev/null 2>&1; then
          
          mv "$output_file.tmp" "$output_file"
          echo "   ‚úÖ SUCCESS - Deleting source ($(date '+%H:%M:%S'))"
          rm "$input_file"
          rmdir "$lock_file"
          PROCESSED=$((PROCESSED + 1))
        else
          echo "   ‚ùå FAILED - Moving to failed directory ($(date '+%H:%M:%S'))"
          rm -f "$output_file.tmp"
          # Move failed file to failed directory to prevent infinite retries
          failed_dest="$FAILED_DIR/$dirname"
          mkdir -p "$failed_dest"
          if mv "$input_file" "$failed_dest/"; then
            echo "   üìÅ Moved to: $failed_dest/"
          else
            echo "   ‚ö†Ô∏è  Could not move to failed directory, file remains in source"
          fi
          rmdir "$lock_file"
          FAILED=$((FAILED + 1))
        fi
      fi
    done
    
    echo ""
    echo "==================================="
    echo "Transcoding Job Complete"
    echo "==================================="
    echo "Pod: $POD_NAME"
    echo "Processed: $PROCESSED files"
    echo "Skipped: $SKIPPED files"
    echo "Failed: $FAILED files (moved to $FAILED_DIR)"
    echo "Note: Successfully processed files are deleted from source"
    echo "Date: $(date)"
    echo "==================================="
